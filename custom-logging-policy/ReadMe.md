# Custom Logging Policy on Mule 4

This guide provides instructions for creating, configuring, and deploying a custom Mule 4 policy that logs incoming and outgoing request/response details (e.g., headers and payloads).

## Prerequisites

- Refer to the top-level `README.md` for prerequisites (Java 17, Anypoint Studio 7.21.0, MuleSoft account) and `settings.xml` setup.

## Creating a Custom Policy

Reference: MuleSoft Custom Policy Documentation

A sample custom policy is available in this directory (`custom-logging-policy`).

### Steps

1. **Obtain Organization ID**:

   - Go to https://anypoint.mulesoft.com/accounts/businessGroups.
   - Select your business group and note the **Business Group ID**.

2. **Generate Custom Policy**:

   Run the following Maven command, replacing `${orgId}` with your organization ID:

   ```bash
   mvn -Parchetype-repository archetype:generate \
   -DarchetypeGroupId=org.mule.tools \
   -DarchetypeArtifactId=api-gateway-custom-policy-archetype \
   -DarchetypeVersion=1.2.0 \
   -DgroupId=${orgId} \
   -DartifactId=custom-logging-policy \
   -Dversion=1.0.0 \
   -Dpackage=mule-policy
   ```

3. **Provide Prompt Details**:

   - `policyDescription`: Custom logging policy
   - `policyName`: custom-logging-policy
   - `groupId`: ${orgId}

4. **Update Policy Configuration**:

   - Replace the contents of `custom-logging-policy.yaml` with the sample provided at `./custom-logging-policy/custom-logging-policy.yaml`.

5. **Modify** `template.xml`:

   - In `src/main/mule/template.xml`, replace the `<http-policy:source>` section with:

     ```xml
     <http-policy:source>
         <logger message="Started inboundLogExpression Policy execution" />
         <logger level="INFO" message="{{{inboundLogExpression}}}"/>
         <logger message="Ended inboundLogExpression Policy execution" />
     
         {{#if requestPayload}}
         <logger message="Started requestPayload Policy execution" />
         <logger level="INFO" message="#[payload]"/>
         <logger message="Ended requestPayload Policy execution" />
         {{/if}}
     
         {{#each logRequestHeader}}
         <logger message="Started logRequestHeader Policy execution" />
         <logger level="INFO" message="{{{this.key}}}:{{{this.value}}}"/>
         <logger message="Ended logRequestHeader Policy execution" />
         {{/each}}
     
         <http-policy:execute-next/>
     
         {{#each logResponseHeader}}
         <logger message="Started logResponseHeader Policy execution" />
         <logger level="INFO" message="{{{this.key}}}:{{{this.value}}}"/>
         <logger message="Ended logResponseHeader Policy execution" />
         {{/each}}
     
         {{#if responsePayload}}
         <logger message="Started responsePayload Policy execution" />
         <logger level="INFO" message="#[payload]"/>
         <logger message="Ended responsePayload Policy execution" />
         {{/if}}
     </http-policy:source>
     ```

6. **Update** `pom.xml`:

   - In `pom.xml`, comment out the following dependency (as it is for enterprise use only):

     ```xml
     <!--
     <dependency>
         <groupId>com.mulesoft.anypoint</groupId>
         <artifactId>mule-http-policy-transform-extension</artifactId>
         <version>${http.policy.transform.extension}</version>
         <classifier>mule-plugin</classifier>
         <exclusions>
             <exclusion>
                 <groupId>org.mule.connectors</groupId>
                 <artifactId>mule-http-connector</artifactId>
             </exclusion>
         </exclusions>
     </dependency>
     -->
     ```

7. **Build and Deploy Policy**:

   - Navigate to the `custom-logging-policy` directory and run:

     ```bash
     mvn clean package
     mvn clean deploy
     ```

8. **Verify Policy**:

   - Visit https://anypoint.mulesoft.com/exchange.
   - Search for **custom logging policy** to confirm the policy is available.

## Applying the Policy

1. **Apply Policy in API Manager**:

   - In Anypoint Platform, navigate to **API Manager**.
   - Select your API (e.g., `hello-world`).
   - Go to **Policies** and click **Apply New Policy**.
   - Choose **custom-logging-policy** from the list.
   - Configure the policy as needed (e.g., specify `inboundLogExpression`, `requestPayload`, `logRequestHeader`, `logResponseHeader`, `responsePayload`).

2. **Save and Apply**:

   - Save the policy configuration and apply it to the API.

## Testing

1. **Invoke the API**:

   - Follow the API invocation steps in the top-level `README.md` to send a request to your API (e.g., `https://hello-world-k4qecw.5sc6y6-2.usa-e2.cloudhub.io/api/greeting`).

2. **Verify Logs**:

   - In **Runtime Manager**, check the **Logs** to view the logs generated by the policy, including request/response headers and payloads as configured.

## Notes

- **Customization**: Adjust the `custom-logging-policy.yaml` and `template.xml` to log specific headers or payloads based on your requirements.
- **Community Edition**: This policy is designed for Mule 4 Community Edition, avoiding enterprise-only dependencies.